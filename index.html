<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppo Problema - Giro dei Bar Slot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 400px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .money-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .balance {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .bet-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .free-spins {
            color: #FFD700;
            font-weight: bold;
        }

        .slot-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin: 20px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .slot {
            aspect-ratio: 1;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden; 
        }
        
        .slot img {
            max-width: 90%; 
            max-height: 90%;
            object-fit: contain; 
            display: block; 
        }

        .slot.spinning {
            animation: quickSpin 0.3s ease-in-out;
        }

        .slot.winning {
            background: #FFD700 !important;
            animation: winningPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700, 0 0 40px #FFD700;
            border: 2px solid #FFA500;
        }

        @keyframes quickSpin {
            0% { transform: rotateY(0deg); opacity: 1; }
            25% { transform: rotateY(90deg); opacity: 0.7; }
            75% { transform: rotateY(270deg); opacity: 0.7; }
            100% { transform: rotateY(360deg); opacity: 1; }
        }

        @keyframes winningPulse {
            0% { 
                background: #FFD700;
                box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700;
                transform: scale(1);
            }
            50% { 
                background: #FFFF00;
                box-shadow: 0 0 20px #FFFF00, 0 0 40px #FFFF00, 0 0 60px #FFFF00;
                transform: scale(1.05);
            }
            100% { 
                background: #FFD700;
                box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700;
                transform: scale(1);
            }
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bet-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 0;
        }

        .clover-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .clover-image, .bell-image, .cherry-image, .star-image, .target-image {
            width: 30px;
            height: 30px;
            opacity: 0.5;
            filter: brightness(0.7);
            object-fit: contain;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 3px;
            border-radius: 5px;
        }

        .clover-image:hover, .bell-image:hover, .cherry-image:hover, .star-image:hover, .target-image:hover {
            transform: scale(1.1);
            opacity: 0.8;
            filter: brightness(1);
            background: rgba(255, 255, 255, 0.1);
        }

        .symbol-highlight {
            opacity: 1;
            filter: brightness(1.2);
            transform: scale(1.1);
            animation: symbolPulse 1.5s ease-in-out infinite;
        }

        @keyframes symbolPulse {
            0% { transform: scale(1.1); filter: brightness(1.2); }
            50% { transform: scale(1.2); filter: brightness(1.4); }
            100% { transform: scale(1.1); filter: brightness(1.2); }
        }

        .bet-button {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .bet-button:hover,
        .bet-button:focus {
            background: #FF5252;
            transform: translateY(-2px);
        }

        .bet-button:active {
            transform: translateY(0);
            background: #FF3030;
        }

        .bet-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #FFD700;
        }

        .spin-button, .auto-button {
            flex-grow: 1; 
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .spin-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }
        
        .auto-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .spin-button:hover,
        .spin-button:focus {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .auto-button:hover,
        .auto-button:focus {
            background: linear-gradient(135deg, #0056b3, #007bff);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .spin-button:active, .auto-button:active {
            transform: translateY(0);
        }

        .spin-button:disabled, .auto-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .win-message {
            background: rgba(76, 175, 80, 0.3);
            animation: pulse 1s ease-in-out;
        }

        .bonus-message {
            background: rgba(255, 215, 0, 0.5);
            animation: bonusPulse 2s ease-in-out infinite;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 15px #FFD700;
            color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            transform-origin: center;
        }

        /* Stile per l'intera app in TOUR MODE */
        body.tour-mode {
            background: linear-gradient(135deg, #000428, #004e92) !important;
            transition: background 0.5s ease;
        }

        .tour-mode {
            position: relative;
            overflow: hidden;
            background: rgba(0, 4, 40, 0.6) !important;
            transition: background 0.5s ease;
        }

        .tour-mode .slot {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tour-mode::before,
        .tour-mode::after,
        .tour-mode .bike-emoji {
            position: absolute;
            font-size: 24px;
            opacity: 0.5;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .tour-mode::before {
            content: '🚴';
            animation: cycleMove 10s linear infinite;
        }

        .tour-mode::after {
            content: '🚴';
            animation: cycleMove 8s linear infinite;
            animation-delay: -4s;
        }

        .tour-mode .bike-emoji:nth-child(3n) {
            content: '🚴';
            animation: cycleMoveDiagonal 12s linear infinite;
        }

        .tour-mode .bike-emoji:nth-child(3n + 1) {
            content: '🚴‍♂️';
            animation: cycleMoveReverse 15s linear infinite;
        }

        .tour-mode .bike-emoji:nth-child(3n + 2) {
            content: '🚴‍♀️';
            animation: cycleMoveCurved 20s linear infinite;
        }

        @keyframes cycleMove {
            0% { transform: translate(-100%, 50%); }
            100% { transform: translate(200%, 50%); }
        }

        @keyframes cycleMoveReverse {
            0% { transform: translate(200%, 30%) scaleX(-1); }
            100% { transform: translate(-100%, 30%) scaleX(-1); }
        }

        @keyframes cycleMoveDiagonal {
            0% { transform: translate(-100%, -100%) rotate(45deg); }
            100% { transform: translate(200%, 200%) rotate(45deg); }
        }

        @keyframes cycleMoveCurved {
            0% { transform: translate(-100%, 0%) rotate(0deg); }
            25% { transform: translate(0%, 25%) rotate(15deg); }
            50% { transform: translate(100%, 50%) rotate(0deg); }
            75% { transform: translate(150%, 25%) rotate(-15deg); }
            100% { transform: translate(200%, 0%) rotate(0deg); }
        }

        .tour-mode .slot.winning {
            background: #FFD700 !important;
            border: 2px solid #FFA500;
        }

        .random-bike {
            position: fixed;
            font-size: 24px;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            animation: bikeFade 4s linear forwards;
        }

        @keyframes bikeFade {
            0% {
                opacity: 0;
                transform: translate(var(--start-x), var(--start-y)) rotate(var(--rotation));
            }
            20% {
                opacity: 0.3;
            }
            80% {
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: translate(var(--end-x), var(--end-y)) rotate(var(--rotation));
            }
        }

        .foundators-message {
            background: rgba(255, 140, 0, 0.6);
            animation: foundatorsPulse 2s ease-in-out infinite;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 15px #FF8C00;
            color: #FFFFFF;
            box-shadow: 0 0 30px rgba(255, 140, 0, 0.7);
            transform-origin: center;
            border: 2px solid #FFA500;
        }

        @keyframes bonusPulse {
            0% { transform: scale(1); background: rgba(255, 215, 0, 0.3); }
            50% { transform: scale(1.1); background: rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1); background: rgba(255, 215, 0, 0.3); }
        }

        @keyframes foundatorsPulse {
            0% { transform: scale(1); background: rgba(255, 140, 0, 0.6); }
            50% { transform: scale(1.15); background: rgba(255, 140, 0, 0.8); text-shadow: 0 0 25px #FF8C00; }
            100% { transform: scale(1); background: rgba(255, 140, 0, 0.6); }
        }

        .lose-message {
            background: rgba(244, 67, 54, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .paytable {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.8em;
        }

        .paytable-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .paytable-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        /* Stili per il popup */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: linear-gradient(135deg, #4a00e0, #8e2de2);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            position: relative;
            animation: popupAppear 0.5s ease-out;
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        @keyframes popupAppear {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup-title {
            font-size: 2em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .popup-message {
            font-size: 1.2em;
            color: white;
            margin-bottom: 25px;
        }

        .number-scroll {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Digital', monospace;
            overflow: hidden;
            position: relative;
            height: 1.2em;
        }

        .number-scroll .number {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
        }

        .number-scroll .number.visible {
            opacity: 1;
        }

        .popup-close {
            background: #ffd700;
            color: #4a00e0;
            border: none;
            padding: 10px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-close:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
        }

        @media (max-width: 320px) {
            .container {
                padding: 10px;
            }
            
            .slot {
                font-size: 1em;
            }
            
            .title {
                font-size: 1.5em;
            }
            
            .slot-grid {
                padding: 8px;
                gap: 2px;
            }

            .popup-content {
                padding: 20px;
            }

            .popup-title {
                font-size: 1.5em;
            }

            .popup-message {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🎰 Gruppo Problema - Giro dei Bar Slot</h1>
        </div>

        <div class="money-display">
            <div class="balance">💰 <span id="balance">100.00</span> €</div>
            <div class="bet-info">
                <span>Puntata: <span id="current-bet">1.00</span> €</span>
                <span class="free-spins">🎁 Free Spins: <span id="free-spins">0</span></span>
            </div>
        </div>

        <div class="slot-grid" id="slot-grid">
            <div class="slot" id="slot-0"></div>
            <div class="slot" id="slot-1"></div>
            <div class="slot" id="slot-2"></div>
            <div class="slot" id="slot-3"></div>
            <div class="slot" id="slot-4"></div>
            <div class="slot" id="slot-5"></div>
            <div class="slot" id="slot-6"></div>
            <div class="slot" id="slot-7"></div>
            <div class="slot" id="slot-8"></div>
            <div class="slot" id="slot-9"></div>
            <div class="slot" id="slot-10"></div>
            <div class="slot" id="slot-11"></div>
            <div class="slot" id="slot-12"></div>
            <div class="slot" id="slot-13"></div>
            <div class="slot" id="slot-14"></div>
            <div class="slot" id="slot-15"></div>
            <div class="slot" id="slot-16"></div>
            <div class="slot" id="slot-17"></div>
            <div class="slot" id="slot-18"></div>
            <div class="slot" id="slot-19"></div>
            <div class="slot" id="slot-20"></div>
            <div class="slot" id="slot-21"></div>
            <div class="slot" id="slot-22"></div>
            <div class="slot" id="slot-23"></div>
            <div class="slot" id="slot-24"></div>
        </div>

        <div class="controls">
            <div class="clover-row">
                <img src="images/clover.png" alt="Clover" class="clover-image">
                <img src="images/bell.png" alt="Bell" class="bell-image">
                <img src="images/cherry.png" alt="Cherry" class="cherry-image">
                <img src="images/star.png" alt="Star" class="star-image">
                <img src="images/target.png" alt="Target" class="target-image">
            </div>
            
            <div class="action-buttons">
                <button class="spin-button" id="spin-button" type="button">
                    GIRA! 🎰
                </button>
                <button class="auto-button" id="auto-button" type="button">
                    AUTO 🔄
                </button>
            </div>

            <div class="bet-controls">
                <button class="bet-button" type="button">-</button>
                <span class="bet-amount"><span id="bet-display">1.00</span> €</span>
                <button class="bet-button" type="button">+</button>
            </div>
        </div>

        <div class="message" id="message">
            Imposta la tua puntata e gira per vincere!
        </div>

        <div class="paytable">
            <div class="paytable-title">💰 TABELLA VINCITE (3+ simboli consecutivi)</div>
            <div class="paytable-row">
                <span><img src="images/diamond.png" alt="Diamond" style="height: 1.2em; vertical-align: middle;"> x5</span>
                <span>100x + 10 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/diamond.png" alt="Diamond" style="height: 1.2em; vertical-align: middle;"> x4</span>
                <span>50x + 5 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/diamond.png" alt="Diamond" style="height: 1.2em; vertical-align: middle;"> x3</span>
                <span>20x + 2 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/star.png" alt="Star" style="height: 1.2em; vertical-align: middle;"> x5</span>
                <span>50x + 5 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/star.png" alt="Star" style="height: 1.2em; vertical-align: middle;"> x4</span>
                <span>25x + 3 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/star.png" alt="Star" style="height: 1.2em; vertical-align: middle;"> x3</span>
                <span>10x + 1 Free Spin</span>
            </div>
            <div class="paytable-row">
                <span>3-5 altri simboli</span>
                <span>3x - 30x</span>
            </div>
        </div>
    </div>

    <!-- Popup per il completamento della clover-row -->
    <div class="popup-overlay" id="completionPopup">
        <div class="popup-content">
            <h2 class="popup-title">🌟 TOUR DEI BAR! 🌟</h2>
            <p class="popup-message">Preparati per il tour dei bar della città!</p>
            <div class="number-scroll" id="numberScroll"></div>
            <p class="popup-message">giri bonus in TOUR MODE! 🚲</p>
            <button class="popup-close" id="closePopup">INIZIA IL GIRO! 🎉</button>
        </div>
    </div>

    <script>
        // Variabili globali
        let balance = 100.00;
        let currentBet = 1.00;
        let freeSpins = 0;
        let spinning = false;
        let autoSpinInterval = null;
        let litSymbols = new Set();
        let tourModeActive = false;
        let tourSpinsRemaining = 0;

        const BONUS_MESSAGE_TIMEOUT = 3000;
        
        // Funzione per generare un numero casuale tra min e max
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        const symbols = ['cherry', 'lemon', 'orange', 'grape', 'star', 'bell', 'diamond', 'clover', 'target'];
        
        const symbolToEmoji = {
            'cherry': '🍒',
            'lemon': '🍋',
            'orange': '🍊',
            'grape': '🍇',
            'star': '⭐',
            'bell': '🔔',
            'diamond': '💎',
            'clover': '🍀',
            'target': '🎯'
        };

        const payouts = {
            'diamond': { 
                3: { multiplier: 20, freeSpins: 2 },
                4: { multiplier: 50, freeSpins: 5 },
                5: { multiplier: 100, freeSpins: 10 }
            },
            'star': { 
                3: { multiplier: 10, freeSpins: 1 },
                4: { multiplier: 25, freeSpins: 3 },
                5: { multiplier: 50, freeSpins: 5 }
            },
            'bell': { 
                3: { multiplier: 8, freeSpins: 0 },
                4: { multiplier: 15, freeSpins: 0 },
                5: { multiplier: 30, freeSpins: 0 }
            },
            'clover': { 
                3: { multiplier: 5, freeSpins: 0 },
                4: { multiplier: 10, freeSpins: 0 },
                5: { multiplier: 20, freeSpins: 0 }
            },
            'cherry': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            },
            'lemon': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            },
            'orange': { 
                3: { multiplier: 3, freeSpins: 10 },
                4: { multiplier: 6, freeSpins: 10 },
                5: { multiplier: 10, freeSpins: 10 }
            },
            'grape': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            },
            'target': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            }
        };

        const balanceEl = document.getElementById('balance');
        const currentBetEl = document.getElementById('current-bet');
        const betDisplayEl = document.getElementById('bet-display');
        const freeSpinsEl = document.getElementById('free-spins');
        const messageEl = document.getElementById('message');
        const spinButton = document.getElementById('spin-button');
        const autoButton = document.getElementById('auto-button');
        const slots = document.querySelectorAll('.slot');

        function increaseBet() {
            if (currentBet < Math.min(balance, 10) && currentBet < 10) {
                currentBet += 0.50;
                updateBetDisplay();
            }
        }

        function decreaseBet() {
            if (currentBet > 0.50) {
                currentBet -= 0.50;
                updateBetDisplay();
            }
        }

        function addTouchEvents() {
            const increaseBetBtn = document.querySelector('.bet-controls .bet-button:last-child');
            const decreaseBetBtn = document.querySelector('.bet-controls .bet-button:first-child');
            
            increaseBetBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.style.transform = 'translateY(0)';
                this.style.background = '#FF3030';
            });
            
            increaseBetBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.style.transform = 'translateY(-2px)';
                this.style.background = '#FF6B6B';
                increaseBet();
            });
            
            increaseBetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                increaseBet();
            });
            
            decreaseBetBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.style.transform = 'translateY(0)';
                this.style.background = '#FF3030';
            });
            
            decreaseBetBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.style.transform = 'translateY(-2px)';
                this.style.background = '#FF6B6B';
                decreaseBet();
            });
            
            decreaseBetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                decreaseBet();
            });
            
            spinButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(0)';
                    this.style.background = 'linear-gradient(135deg, #3d8b40, #45a049)';
                }
            });
            
            spinButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(-3px)';
                    this.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    spin();
                }
            });
            
            spinButton.addEventListener('click', function(e) {
                e.preventDefault();
                spin();
            });
            
            autoButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(0)';
                    this.style.background = 'linear-gradient(135deg, #00458a, #0056b3)';
                }
            });
            
            autoButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(-3px)';
                    this.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
                    toggleAutoSpin();
                }
            });
            
            autoButton.addEventListener('click', function(e) {
                e.preventDefault();
                toggleAutoSpin();
            });
        }

        function updateBetDisplay() {
            currentBetEl.textContent = currentBet.toFixed(2);
            betDisplayEl.textContent = currentBet.toFixed(2);
        }

        function updateBalance() {
            balanceEl.textContent = balance.toFixed(2);
        }

        function updateFreeSpins() {
            freeSpinsEl.textContent = freeSpins;
        }

        function updateMessage(text, type = '') {
            messageEl.textContent = text;
            messageEl.className = 'message ' + type;
        }

        function getRandomSymbol() {
            return symbols[Math.floor(Math.random() * symbols.length)];
        }

        // Funzione per attivare la TOUR MODE
        function activateTourMode(spins) {
            tourModeActive = true;
            tourSpinsRemaining = spins;
            document.body.classList.add('tour-mode');
            document.querySelector('.slot-grid').classList.add('tour-mode');
            updateMessage(`🚲 TOUR MODE: ${tourSpinsRemaining} giri rimanenti 🚴`, 'bonus-message');
            
            // Funzione per creare una bicicletta random
            function createRandomBike() {
                const bikeEmojis = ['🚲', '🚴', '🚴‍♂️', '🚴‍♀️', '🚵', '🚵‍♂️', '🚵‍♀️'];
                const bike = document.createElement('div');
                bike.className = 'random-bike';
                bike.textContent = bikeEmojis[Math.floor(Math.random() * bikeEmojis.length)];
                
                // Posizioni di partenza e arrivo casuali
                const startX = -100 + Math.random() * 50; // Parte da fuori schermo a sinistra
                const endX = 100 + Math.random() * 50; // Finisce fuori schermo a destra
                const startY = Math.random() * 100;
                const endY = startY + (Math.random() - 0.5) * 50; // Movimento verticale limitato
                const rotation = Math.random() * 360;
                
                bike.style.setProperty('--start-x', startX + 'vw');
                bike.style.setProperty('--start-y', startY + 'vh');
                bike.style.setProperty('--end-x', endX + 'vw');
                bike.style.setProperty('--end-y', endY + 'vh');
                bike.style.setProperty('--rotation', rotation + 'deg');
                
                document.body.appendChild(bike);
                
                // Rimuovi la bicicletta dopo l'animazione
                bike.addEventListener('animationend', () => {
                    bike.remove();
                });
            }
            
            // Crea biciclette iniziali (più numerose)
            for (let i = 0; i < 12; i++) {
                setTimeout(() => createRandomBike(), i * 500); // Ridotto il delay tra le biciclette
            }
            
            // Continua a creare nuove biciclette più frequentemente
            const bikeInterval = setInterval(() => {
                if (!tourModeActive) {
                    clearInterval(bikeInterval);
                    document.querySelectorAll('.random-bike').forEach(bike => bike.remove());
                    return;
                }
                createRandomBike();
                // Crea una seconda bicicletta con un leggero ritardo
                setTimeout(() => createRandomBike(), 300);
            }, 1000); // Ridotto l'intervallo tra le ondate di biciclette
        }
        
        function toggleAutoSpin() {
            if (autoSpinInterval) {
                clearInterval(autoSpinInterval);
                autoSpinInterval = null;
                autoButton.textContent = 'AUTO 🔄';
                spinButton.disabled = false;
                updateMessage('Modalità automatica disattivata', '');
            } else {
                if (balance < currentBet && freeSpins === 0) {
                    updateMessage('Saldo insufficiente per la modalità automatica!', 'lose-message');
                    return;
                }
                
                autoButton.textContent = 'STOP AUTO ⏹️';
                spinButton.disabled = true;
                updateMessage('Modalità automatica attiva...', 'win-message');
                
                spin();
                autoSpinInterval = setInterval(() => {
                    if (balance < currentBet && freeSpins === 0) {
                        clearInterval(autoSpinInterval);
                        autoSpinInterval = null;
                        autoButton.textContent = 'AUTO 🔄';
                        spinButton.disabled = true;
                        updateMessage('Game Over! Ricarica il saldo per continuare.', 'lose-message');
                        spinButton.textContent = 'SALDO ESAURITO';
                    } else if (!spinning) {
                        spin();
                    }
                }, 3000); 
            }
        }

        function checkConsecutiveSymbols(line, symbol) {
            let maxConsecutive = 0;
            let currentConsecutive = 0;
            let startIndex = -1;
            let bestStartIndex = -1;
            
            for (let i = 0; i < line.length; i++) {
                if (line[i] === symbol) {
                    if (currentConsecutive === 0) {
                        startIndex = i;
                    }
                    currentConsecutive++;
                } else {
                    if (currentConsecutive > maxConsecutive) {
                        maxConsecutive = currentConsecutive;
                        bestStartIndex = startIndex;
                    }
                    currentConsecutive = 0;
                }
            }
            
            if (currentConsecutive > maxConsecutive) {
                maxConsecutive = currentConsecutive;
                bestStartIndex = startIndex;
            }
            
            return { count: maxConsecutive, startIndex: bestStartIndex };
        }

        function checkWin() {
            const grid = [];
            slots.forEach((slot, index) => {
                const row = Math.floor(index / 5);
                const col = index % 5;
                if (!grid[row]) grid[row] = [];
                grid[row][col] = slot.dataset.symbol; 
            });

            let winningLines = [];
            let totalWin = 0;
            let bonusFreeSpins = 0;

            for (let row = 0; row < 5; row++) {
                const rowSymbols = grid[row];
                const uniqueSymbols = [...new Set(rowSymbols)];
                
                for (const symbol of uniqueSymbols) {
                    const result = checkConsecutiveSymbols(rowSymbols, symbol);
                    if (result.count >= 3 && payouts[symbol]) {
                        const payout = payouts[symbol][result.count];
                        if (payout) {
                            const positions = [];
                            for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                                positions.push(row * 5 + i);
                            }
                            winningLines.push({
                                type: 'row',
                                index: row,
                                symbol: symbol,
                                count: result.count,
                                positions: positions
                            });
                            totalWin += currentBet * payout.multiplier;
                            bonusFreeSpins += payout.freeSpins;
                        }
                    }
                }
            }

            for (let col = 0; col < 5; col++) {
                const colSymbols = [];
                for (let row = 0; row < 5; row++) {
                    colSymbols.push(grid[row][col]);
                }
                const uniqueSymbols = [...new Set(colSymbols)];
                
                for (const symbol of uniqueSymbols) {
                    const result = checkConsecutiveSymbols(colSymbols, symbol);
                    if (result.count >= 3 && payouts[symbol]) {
                        const payout = payouts[symbol][result.count];
                        if (payout) {
                            const positions = [];
                            for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                                positions.push(i * 5 + col);
                            }
                            winningLines.push({
                                type: 'col',
                                index: col,
                                symbol: symbol,
                                count: result.count,
                                positions: positions
                            });
                            totalWin += currentBet * payout.multiplier;
                            bonusFreeSpins += payout.freeSpins;
                        }
                    }
                }
            }

            const diag1Symbols = [];
            for (let i = 0; i < 5; i++) {
                diag1Symbols.push(grid[i][i]);
            }
            const uniqueDiag1 = [...new Set(diag1Symbols)];
            
            for (const symbol of uniqueDiag1) {
                const result = checkConsecutiveSymbols(diag1Symbols, symbol);
                if (result.count >= 3 && payouts[symbol]) {
                    const payout = payouts[symbol][result.count];
                    if (payout) {
                        const positions = [];
                        for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                            positions.push(i * 6);
                        }
                        winningLines.push({
                            type: 'diag1',
                            symbol: symbol,
                            count: result.count,
                            positions: positions
                        });
                        totalWin += currentBet * payout.multiplier;
                        bonusFreeSpins += payout.freeSpins;
                    }
                }
            }

            const diag2Symbols = [];
            for (let i = 0; i < 5; i++) {
                diag2Symbols.push(grid[i][4-i]);
            }
            const uniqueDiag2 = [...new Set(diag2Symbols)];
            
            for (const symbol of uniqueDiag2) {
                const result = checkConsecutiveSymbols(diag2Symbols, symbol);
                if (result.count >= 3 && payouts[symbol]) {
                    const payout = payouts[symbol][result.count];
                    if (payout) {
                        const positions = [];
                        for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                            positions.push(i * 4 + 4); 
                        }
                        winningLines.push({
                            type: 'diag2',
                            symbol: symbol,
                            count: result.count,
                            positions: positions
                        });
                        totalWin += currentBet * payout.multiplier;
                        bonusFreeSpins += payout.freeSpins;
                    }
                }
            }

            // Check for PADRI FONDATORI combination (orange, grape, lemon in any order)
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col <= 2; col++) {
                    const threeSymbols = [
                        grid[row][col],
                        grid[row][col + 1],
                        grid[row][col + 2]
                    ];
                    
                    const foundatorsSymbols = new Set(['orange', 'grape', 'lemon']);
                    const currentSymbols = new Set(threeSymbols);
                    
                    if (threeSymbols.every(symbol => foundatorsSymbols.has(symbol)) &&
                        currentSymbols.size === 3) { // All three must be different
                        const positions = [
                            row * 5 + col,
                            row * 5 + (col + 1),
                            row * 5 + (col + 2)
                        ];
                        winningLines.push({
                            type: 'foundators',
                            positions: positions,
                            symbol: 'foundators'
                        });
                        // Add special bonus for PADRI FONDATORI (77x multiplier)
                        totalWin += currentBet * 77;
                        bonusFreeSpins += 7; // 7 free spins for luck
                    }
                }
            }

            return { winningLines, totalWin, bonusFreeSpins };
        }

        function highlightWinningLines(winningLines) {
            // Reset slot highlights
            slots.forEach(slot => {
                slot.classList.remove('winning');
            });

            // Set of winning symbols for this spin
            const winningSymbols = new Set();

            winningLines.forEach(line => {
                line.positions.forEach(pos => {
                    slots[pos].classList.add('winning');
                });
                winningSymbols.add(line.symbol);
            });

            // Add new winning symbols to the permanent lit set
            winningSymbols.forEach(symbol => {
                litSymbols.add(symbol);
                const symbolImg = document.querySelector(`.${symbol}-image`);
                if (symbolImg) {
                    symbolImg.classList.add('symbol-highlight');
                }
            });

            // Check if all symbols in the row are lit
            const symbolsInRow = ['clover', 'bell', 'cherry', 'star', 'target'];
            const allSymbolsLit = symbolsInRow.every(symbol => litSymbols.has(symbol));

            // If all symbols are lit, show the BONUS message
            if (allSymbolsLit) {
                const finalTourSpins = getRandomInt(10, 50);
                const bonusAmount = currentBet * 50; // Bonus fisso di 50x
                balance += bonusAmount;
                updateBalance();

                // Show popup and start number animation
                const popup = document.getElementById('completionPopup');
                const numberScroll = document.getElementById('numberScroll');
                popup.style.display = 'flex';
                updateMessage(`🌟 GIRO DEI BAR! +${bonusAmount.toFixed(2)}€ 🌟`, 'bonus-message');

                // Funzione per creare l'effetto di scrolling dei numeri
                function animateNumbers() {
                    let duration = 2000;
                    let steps = 30;
                    let interval = duration / steps;
                    let count = 0;

                    numberScroll.innerHTML = '';
                    
                    const animation = setInterval(() => {
                        count++;
                        let randomNum = getRandomInt(10, 50);
                        
                        // Rimuovi il numero precedente
                        const oldNumber = numberScroll.querySelector('.visible');
                        if (oldNumber) {
                            oldNumber.classList.remove('visible');
                            setTimeout(() => oldNumber.remove(), 100);
                        }

                        // Aggiungi il nuovo numero
                        const numberDiv = document.createElement('div');
                        numberDiv.className = 'number';
                        numberDiv.textContent = count >= steps ? finalTourSpins : randomNum;
                        numberScroll.appendChild(numberDiv);
                        
                        // Forza un reflow
                        numberDiv.offsetHeight;
                        
                        // Rendi visibile il numero
                        numberDiv.classList.add('visible');

                        if (count >= steps) {
                            clearInterval(animation);
                        }
                    }, interval);
                }

                // Avvia l'animazione dei numeri
                animateNumbers();

                // Stop auto-spin if active
                if (autoSpinInterval) {
                    clearInterval(autoSpinInterval);
                    autoSpinInterval = null;
                    autoButton.textContent = 'AUTO 🔄';
                    spinButton.disabled = false;
                }

                // Handle popup close button
                document.getElementById('closePopup').onclick = function() {
                    popup.style.display = 'none';
                    activateTourMode(finalTourSpins);
                };

                // Reset lit symbols after timeout
                setTimeout(() => {
                    litSymbols.clear();
                    document.querySelectorAll('.clover-image, .bell-image, .cherry-image, .star-image, .target-image')
                        .forEach(img => img.classList.remove('symbol-highlight'));
                    updateMessage('Simboli resettati! Raccoglili di nuovo!', '');
                }, BONUS_MESSAGE_TIMEOUT);
            }
        }

        async function spin() {
            if (spinning) return;
            
            if (tourModeActive) {
                tourSpinsRemaining--;
                updateMessage(`🚲 TOUR MODE: ${tourSpinsRemaining} giri rimanenti 🚴`, 'bonus-message');
                if (tourSpinsRemaining === 0) {
                    tourModeActive = false;
                    document.body.classList.remove('tour-mode');
                    document.querySelector('.slot-grid').classList.remove('tour-mode');
                    // Rimuovi tutte le biciclette random
                    document.querySelectorAll('.random-bike').forEach(bike => bike.remove());
                    updateMessage('TOUR MODE completato! 🏁', 'win-message');
                }
            }
            
            if (balance < currentBet && freeSpins === 0) {
                updateMessage('Saldo insufficiente!', 'lose-message');
                if (autoSpinInterval) {
                    clearInterval(autoSpinInterval);
                    autoSpinInterval = null;
                    autoButton.textContent = 'AUTO 🔄';
                    spinButton.disabled = true;
                    spinButton.textContent = 'SALDO ESAURITO';
                }
                return;
            }

            spinning = true;
            spinButton.disabled = true;
            
            if (!autoSpinInterval) {
                 spinButton.textContent = 'GIRANDO...';
            }

            slots.forEach(slot => {
                slot.classList.remove('winning');
            });

            let isFreeSpinUsed = false;
            if (freeSpins > 0) {
                freeSpins--;
                isFreeSpinUsed = true;
                updateFreeSpins();
                updateMessage('FREE SPIN! 🎁', 'win-message');
            } else {
                balance -= currentBet;
                updateBalance();
            }

            slots.forEach(slot => {
                slot.classList.add('spinning');
            });

            await new Promise(resolve => setTimeout(resolve, 300));

            slots.forEach(slot => {
                const randomSymbolName = getRandomSymbol();
                slot.dataset.symbol = randomSymbolName; 
                slot.innerHTML = `<img src="images/${randomSymbolName}.png" alt="${randomSymbolName}">`;
                slot.classList.remove('spinning');
            });

            await new Promise(resolve => setTimeout(resolve, 100));

            const result = checkWin();
            
            if (result.winningLines.length > 0) {
                highlightWinningLines(result.winningLines);
                
                balance += result.totalWin;
                freeSpins += result.bonusFreeSpins;
                
                // Check for PADRI FONDATORI special win
                const foundatorsWin = result.winningLines.find(line => line.type === 'foundators');
                if (foundatorsWin) {
                    const message = `🏆 PADRI FONDATORI! +${(currentBet * 77).toFixed(2)}€ + 7 Free Spins! 🎰`;
                    updateMessage(message, 'foundators-message');
                } else {
                    let message = `🎉 VINCITA! +${result.totalWin.toFixed(2)}€`;
                    if (result.bonusFreeSpins > 0) {
                        message += ` + ${result.bonusFreeSpins} Free Spins! 🎁`;
                    }
                    
                    const bestWin = result.winningLines.reduce((best, line) => 
                        line.count > best.count ? line : best
                    );
                    message += ` (${bestWin.count} ${symbolToEmoji[bestWin.symbol]})`;
                    
                    updateMessage(message, 'win-message');
                }
                
                updateBalance();
                updateFreeSpins();
            } else {
                if (!isFreeSpinUsed) {
                    updateMessage('Riprova! 🎲', 'lose-message');
                } else {
                    updateMessage('Free Spin utilizzato! 🎁', 'lose-message');
                }
            }
            
            setTimeout(() => {
                if (balance < currentBet && freeSpins === 0) {
                    updateMessage('Game Over! Ricarica il saldo per continuare.', 'lose-message');
                    spinButton.textContent = 'SALDO ESAURITO';
                    spinButton.disabled = true;
                    autoButton.disabled = true;
                } else {
                    if (!autoSpinInterval) {
                        spinButton.disabled = false;
                        spinButton.textContent = freeSpins > 0 ? 'GIRA GRATIS! 🎁' : 'GIRA! 🎰';
                    }
                    autoButton.disabled = false;
                }
                spinning = false;
            }, 500);
        }

        function initializeSlots() {
            slots.forEach(slot => {
                const randomSymbolName = getRandomSymbol();
                slot.dataset.symbol = randomSymbolName;
                slot.innerHTML = `<img src="images/${randomSymbolName}.png" alt="${randomSymbolName}">`;
            });
        }

        function toggleSymbol(symbol) {
            const symbolImg = document.querySelector(`.${symbol}-image`);
            if (symbolImg) {
                if (symbolImg.classList.contains('symbol-highlight')) {
                    symbolImg.classList.remove('symbol-highlight');
                    litSymbols.delete(symbol);
                } else {
                    symbolImg.classList.add('symbol-highlight');
                    litSymbols.add(symbol);
                }

                // Controlla se tutti i simboli sono attivati
                const symbolsInRow = ['clover', 'bell', 'cherry', 'star', 'target'];
                const allSymbolsLit = symbolsInRow.every(s => litSymbols.has(s));

                if (allSymbolsLit) {
                    const finalTourSpins = getRandomInt(10, 50);
                    const bonusAmount = currentBet * 50;
                    balance += bonusAmount;
                    updateBalance();

                    const popup = document.getElementById('completionPopup');
                    const numberScroll = document.getElementById('numberScroll');
                    popup.style.display = 'flex';
                    updateMessage(`🌟 GIRO DEI BAR! +${bonusAmount.toFixed(2)}€ 🌟`, 'bonus-message');

                    function animateNumbers() {
                        let duration = 2000;
                        let steps = 30;
                        let interval = duration / steps;
                        let count = 0;

                        numberScroll.innerHTML = '';
                        
                        const animation = setInterval(() => {
                            count++;
                            let randomNum = getRandomInt(10, 50);
                            
                            const oldNumber = numberScroll.querySelector('.visible');
                            if (oldNumber) {
                                oldNumber.classList.remove('visible');
                                setTimeout(() => oldNumber.remove(), 100);
                            }

                            const numberDiv = document.createElement('div');
                            numberDiv.className = 'number';
                            numberDiv.textContent = count >= steps ? finalTourSpins : randomNum;
                            numberScroll.appendChild(numberDiv);
                            
                            numberDiv.offsetHeight;
                            
                            numberDiv.classList.add('visible');

                            if (count >= steps) {
                                clearInterval(animation);
                            }
                        }, interval);
                    }

                    animateNumbers();

                    if (autoSpinInterval) {
                        clearInterval(autoSpinInterval);
                        autoSpinInterval = null;
                        autoButton.textContent = 'AUTO 🔄';
                        spinButton.disabled = false;
                    }

                    document.getElementById('closePopup').onclick = function() {
                        popup.style.display = 'none';
                        activateTourMode(finalTourSpins);
                    };

                    setTimeout(() => {
                        litSymbols.clear();
                        document.querySelectorAll('.clover-image, .bell-image, .cherry-image, .star-image, .target-image')
                            .forEach(img => img.classList.remove('symbol-highlight'));
                        updateMessage('Simboli resettati! Raccoglili di nuovo!', '');
                    }, BONUS_MESSAGE_TIMEOUT);
                }
            }
        }

        // Aggiungi event listener per i click sui simboli
        document.querySelector('.clover-image').addEventListener('click', () => toggleSymbol('clover'));
        document.querySelector('.bell-image').addEventListener('click', () => toggleSymbol('bell'));
        document.querySelector('.cherry-image').addEventListener('click', () => toggleSymbol('cherry'));
        document.querySelector('.star-image').addEventListener('click', () => toggleSymbol('star'));
        document.querySelector('.target-image').addEventListener('click', () => toggleSymbol('target'));
        
        updateBalance();
        updateBetDisplay();
        updateFreeSpins();
        initializeSlots();
        addTouchEvents();

        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>