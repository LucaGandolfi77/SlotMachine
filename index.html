<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppo Problema - Giro dei Bar Slot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: white;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 400px;
            width: 100%;
            position: relative; /* per contenere le bici assolute */
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative; /* Per posizionare il bottone audio */
        }

        .sound-button {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .sound-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .title {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .money-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .balance {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .bet-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .free-spins {
            color: #FFD700;
            font-weight: bold;
        }

        .slot-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin: 20px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative; /* per gestire layering con le bici */
            z-index: 150;
        }

        .slot {
            aspect-ratio: 1;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden; 
        }
        
        .slot img {
            max-width: 90%; 
            max-height: 90%;
            object-fit: contain; 
            display: block; 
        }

        .slot.spinning {
            animation: spinBlur 0.1s infinite linear;
        }

        .slot.stopping {
            animation: stopBounce 0.4s ease-out;
        }

        .slot.winning {
            background: #FFD700 !important;
            animation: winningPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700, 0 0 40px #FFD700;
            border: 2px solid #FFA500;
        }

        @keyframes spinBlur {
            0% { transform: scaleY(1); opacity: 1; }
            50% { transform: scaleY(0.6) translateY(5px); opacity: 0.5; }
            100% { transform: scaleY(1); opacity: 1; }
        }

        @keyframes stopBounce {
            0% { transform: translateY(-50px); opacity: 0; }
            60% { transform: translateY(10px); opacity: 1; }
            80% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        @keyframes winningPulse {
            0% { 
                background: #FFD700;
                box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700;
                transform: scale(1);
            }
            50% { 
                background: #FFFF00;
                box-shadow: 0 0 20px #FFFF00, 0 0 40px #FFFF00, 0 0 60px #FFFF00;
                transform: scale(1.05);
            }
            100% { 
                background: #FFD700;
                box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700;
                transform: scale(1);
            }
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 200; /* sopra le bici */
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bet-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 0;
        }

        .clover-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .clover-image, .bell-image, .cherry-image, .star-image, .target-image {
            width: 30px;
            height: 30px;
            opacity: 0.5;
            filter: brightness(0.7);
            object-fit: contain;
            transition: all 0.3s ease;
            /*cursor: pointer;*/
            /* Disabilitiamo l'interazione via click/touch: le icone sono solo indicatori ora */
            pointer-events: none;
            cursor: default;
            padding: 3px;
            border-radius: 5px;
        }

        .clover-image:hover, .bell-image:hover, .cherry-image:hover, .star-image:hover, .target-image:hover {
            transform: scale(1.1);
            opacity: 0.8;
            filter: brightness(1);
            background: rgba(255, 255, 255, 0.1);
        }

        .symbol-highlight {
            opacity: 1;
            filter: brightness(1.2);
            transform: scale(1.1);
            animation: symbolPulse 1.5s ease-in-out infinite;
        }

        @keyframes symbolPulse {
            0% { transform: scale(1.1); filter: brightness(1.2); }
            50% { transform: scale(1.2); filter: brightness(1.4); }
            100% { transform: scale(1.1); filter: brightness(1.2); }
        }

        .bet-button {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .bet-button:hover,
        .bet-button:focus {
            background: #FF5252;
            transform: translateY(-2px);
        }

        .bet-button:active {
            transform: translateY(0);
            background: #FF3030;
        }

        .bet-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #FFD700;
        }

        .spin-button, .auto-button {
            flex-grow: 1; 
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .spin-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }
        
        .auto-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .spin-button:hover,
        .spin-button:focus {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .auto-button:hover,
        .auto-button:focus {
            background: linear-gradient(135deg, #0056b3, #007bff);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .spin-button:active, .auto-button:active {
            transform: translateY(0);
        }

        .spin-button:disabled, .auto-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .win-message {
            background: rgba(76, 175, 80, 0.3);
            animation: pulse 1s ease-in-out;
        }

        .bonus-message {
            background: rgba(255, 215, 0, 0.5);
            animation: bonusPulse 2s ease-in-out infinite;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 15px #FFD700;
            color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            transform-origin: center;
        }

        /* Stile per l'intera app in TOUR MODE */
        body.tour-mode {
            background: linear-gradient(135deg, #000428, #004e92) !important;
            transition: background 0.5s ease;
        }

        .tour-mode {
            position: relative;
            overflow: hidden;
            background: rgba(0, 4, 40, 0.6) !important;
            transition: background 0.5s ease;
        }

        .tour-mode .slot {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tour-mode::before,
        .tour-mode::after,
        .tour-mode .bike-emoji {
            display: none !important;
        }

        .tour-mode .slot.winning {
            background: #FFD700 !important;
            border: 2px solid #FFA500;
        }

        /* Stile per le biciclette dinamiche */
        .bike {
            position: absolute;
            font-size: 32px;
            opacity: 0.9;
            pointer-events: none;
            z-index: 1000; /* Assicura che siano sopra a tutto */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            will-change: transform;
        }

        /* Scia delle bici */
        .bike-trail {
            font-size: 28px;
            filter: blur(0.3px) drop-shadow(0 0 4px rgba(255,255,255,0.4));
            pointer-events: none; /* non intercetta i tocchi */
        }

        /* Modalit√† leggera per mobile */
        body.mobile-lite {
            justify-content: flex-start;
            align-items: stretch;
            padding-top: 4px;
            overflow-y: auto;
        }
        body.mobile-lite .container {
            padding: 10px 12px 12px;
            max-width: 360px;
            min-height: calc(100vh - 40px);
            position: relative;
            z-index: 2;
        }
        body.mobile-lite .slot-grid { padding: 8px; gap: 2px; }
        body.mobile-lite .spin-button, body.mobile-lite .auto-button { padding: 16px; }

        .random-bike {
            position: fixed;
            font-size: 24px;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            animation: bikeFade 4s linear forwards;
        }

        @keyframes bikeFade {
            0% {
                opacity: 0;
                transform: translate(var(--start-x), var(--start-y)) rotate(var(--rotation));
            }
            20% {
                opacity: 0.3;
            }
            80% {
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: translate(var(--end-x), var(--end-y)) rotate(var(--rotation));
            }
        }

        .foundators-message {
            background: rgba(255, 140, 0, 0.5);
            animation: foundatorsPulse 2s ease-in-out infinite;
            /* Slightly larger than a normal win message, but much smaller than before */
            font-size: 1.15em;
            font-weight: 700;
            text-shadow: 0 0 8px #FF8C00;
            color: #FFFFFF;
            /* Subtle glow instead of a large box-shadow */
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.35);
            transform-origin: center;
            border: 1px solid rgba(255,165,0,0.7);
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        @keyframes bonusPulse {
            0% { transform: scale(1); background: rgba(255, 215, 0, 0.3); }
            50% { transform: scale(1.1); background: rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1); background: rgba(255, 215, 0, 0.3); }
        }

        @keyframes foundatorsPulse {
            0% { transform: scale(1); background: rgba(255, 140, 0, 0.6); }
            50% { transform: scale(1.15); background: rgba(255, 140, 0, 0.8); text-shadow: 0 0 25px #FF8C00; }
            100% { transform: scale(1); background: rgba(255, 140, 0, 0.6); }
        }

        .lose-message {
            background: rgba(244, 67, 54, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .paytable {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.8em;
        }

        .paytable-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .paytable-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        /* Stili per il popup */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: linear-gradient(135deg, #4a00e0, #8e2de2);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            position: relative;
            animation: popupAppear 0.5s ease-out;
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        @keyframes popupAppear {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup-title {
            font-size: 2em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .popup-message {
            font-size: 1.2em;
            color: white;
            margin-bottom: 25px;
        }

        .number-scroll {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Digital', monospace;
            overflow: hidden;
            position: relative;
            height: 1.2em;
        }

        .number-scroll .number {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
        }

        .number-scroll .number.visible {
            opacity: 1;
        }

        .popup-close {
            background: #ffd700;
            color: #4a00e0;
            border: none;
            padding: 10px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-close:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
        }

        @media (max-width: 320px) {
            .container {
                padding: 10px;
            }
            
            .slot {
                font-size: 1em;
            }
            
            .title {
                font-size: 1.5em;
            }
            
            .slot-grid {
                padding: 8px;
                gap: 2px;
            }

            .popup-content {
                padding: 20px;
            }

            .popup-title {
                font-size: 1.5em;
            }

            .popup-message {
                font-size: 1em;
            }
        }

        /* Position sound toggle inside the money-display box */
        .money-display {
            position: relative;
        }

        .money-display .sound-button {
            position: absolute;
            top: 8px;
            right: 12px;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            color: #fff;
            border: none;
            box-shadow: none;
            font-size: 1em;
            line-height: 1;
        }

        @media (max-width: 760px) {
            .money-display .sound-button {
                top: 6px;
                right: 8px;
                padding: 6px 8px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üé∞ Gruppo Problema - Giro dei Bar Slot</h1>
        </div>

        <div class="money-display">
            <!-- Moved sound toggle here so it's inside the dark money box above Free Spins -->
            <button id="sound-toggle" class="sound-button" aria-label="Toggle Sound">üîá</button>
            <div class="balance">üí∞ <span id="balance">100.00</span> ‚Ç¨</div>
            <div class="bet-info">
                <span>Puntata: <span id="current-bet">1.00</span> ‚Ç¨</span>
                <span class="free-spins">üéÅ Free Spins: <span id="free-spins">0</span></span>
            </div>
        </div>

        <div class="slot-grid" id="slot-grid">
            <div class="slot" id="slot-0"></div>
            <div class="slot" id="slot-1"></div>
            <div class="slot" id="slot-2"></div>
            <div class="slot" id="slot-3"></div>
            <div class="slot" id="slot-4"></div>
            <div class="slot" id="slot-5"></div>
            <div class="slot" id="slot-6"></div>
            <div class="slot" id="slot-7"></div>
            <div class="slot" id="slot-8"></div>
            <div class="slot" id="slot-9"></div>
            <div class="slot" id="slot-10"></div>
            <div class="slot" id="slot-11"></div>
            <div class="slot" id="slot-12"></div>
            <div class="slot" id="slot-13"></div>
            <div class="slot" id="slot-14"></div>
            <div class="slot" id="slot-15"></div>
            <div class="slot" id="slot-16"></div>
            <div class="slot" id="slot-17"></div>
            <div class="slot" id="slot-18"></div>
            <div class="slot" id="slot-19"></div>
            <div class="slot" id="slot-20"></div>
            <div class="slot" id="slot-21"></div>
            <div class="slot" id="slot-22"></div>
            <div class="slot" id="slot-23"></div>
            <div class="slot" id="slot-24"></div>
        </div>

        <div class="controls">
            <div class="clover-row">
                <img src="images/clover.png" alt="Clover" class="clover-image">
                <img src="images/bell.png" alt="Bell" class="bell-image">
                <img src="images/cherry.png" alt="Cherry" class="cherry-image">
                <img src="images/star.png" alt="Star" class="star-image">
                <img src="images/target.png" alt="Target" class="target-image">
            </div>
            
            <div class="action-buttons">
                <button class="spin-button" id="spin-button" type="button">
                    GIRA! üé∞
                </button>
                <button class="auto-button" id="auto-button" type="button">
                    AUTO üîÑ
                </button>
            </div>

        </div>

        <div class="message" id="message">
            Gira per bere in tutti i bar e vincere!
        </div>

        <div class="paytable">
            <div class="paytable-title">üí∞ TABELLA VINCITE (3+ simboli consecutivi)</div>
            <div class="paytable-row">
                <span><img src="images/diamond.png" alt="Diamond" style="height: 1.2em; vertical-align: middle;"> x5</span>
                <span>100x + 10 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/diamond.png" alt="Diamond" style="height: 1.2em; vertical-align: middle;"> x4</span>
                <span>50x + 5 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/diamond.png" alt="Diamond" style="height: 1.2em; vertical-align: middle;"> x3</span>
                <span>20x + 2 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/star.png" alt="Star" style="height: 1.2em; vertical-align: middle;"> x5</span>
                <span>50x + 5 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/star.png" alt="Star" style="height: 1.2em; vertical-align: middle;"> x4</span>
                <span>25x + 3 Free Spins</span>
            </div>
            <div class="paytable-row">
                <span><img src="images/star.png" alt="Star" style="height: 1.2em; vertical-align: middle;"> x3</span>
                <span>10x + 1 Free Spin</span>
            </div>
            <div class="paytable-row">
                <span>3-5 altri simboli</span>
                <span>3x - 30x</span>
            </div>
        </div>
    </div>

    <!-- Popup per il completamento della clover-row -->
    <div class="popup-overlay" id="completionPopup">
        <div class="popup-content">
            <h2 class="popup-title">üåü TOUR DEI BAR! üåü</h2>
            <p class="popup-message">Preparati per il tour dei bar della citt√†!</p>
            <div class="number-scroll" id="numberScroll"></div>
            <p class="popup-message">giri bonus in GIRO DEI BAR! üö≤</p>
            <button class="popup-close" id="closePopup">INIZIA IL GIRO! üéâ</button>
        </div>
    </div>

    <script src="swarm.js"></script>

    <script>
        // Sound Manager Class
        class SoundManager {
            constructor() {
                this.muted = true;
                this.ctx = null;
                this.bgInterval = null;
            }

            init() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                if (!this.muted) {
                    this.init();
                    this.startBackground();
                    return false;
                } else {
                    this.stopBackground();
                    return true;
                }
            }

            playTone(freq, type, duration, startTime = 0, vol = 0.1) {
                if (this.muted || !this.ctx) return;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                
                gain.gain.setValueAtTime(vol, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + startTime + duration);
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.start(this.ctx.currentTime + startTime);
                osc.stop(this.ctx.currentTime + startTime + duration);
            }

            startBackground() {
                if (this.bgInterval) clearInterval(this.bgInterval);
                if (this.muted) return;

                // Simple rhythmic beat
                const playBeat = () => {
                    if (this.muted) return;
                    // Base beat
                    this.playTone(100, 'sine', 0.1, 0, 0.05);
                    // Off-beat
                    setTimeout(() => {
                        if (!this.muted) this.playTone(150, 'triangle', 0.05, 0, 0.03);
                    }, 500);
                };

                playBeat();
                this.bgInterval = setInterval(playBeat, 1000);
            }

            stopBackground() {
                if (this.bgInterval) {
                    clearInterval(this.bgInterval);
                    this.bgInterval = null;
                }
            }

            playSpin() {
                if (this.muted) return;
                // Mechanical spinning sound simulation
                for(let i=0; i<10; i++) {
                    this.playTone(200 + Math.random()*100, 'square', 0.05, i*0.05, 0.03);
                }
            }

            playWin() {
                if (this.muted) return;
                // Victory fanfare (C Major)
                const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50]; 
                notes.forEach((note, i) => {
                    this.playTone(note, 'sine', 0.2, i*0.1, 0.1);
                });
            }

            playLose() {
                if (this.muted) return;
                // Sad trombone-ish
                this.playTone(400, 'sawtooth', 0.3, 0, 0.05);
                this.playTone(350, 'sawtooth', 0.3, 0.2, 0.05);
                this.playTone(300, 'sawtooth', 0.5, 0.4, 0.05);
            }
        }

        // Variabili globali
        const soundManager = new SoundManager();
        let balance = 100.00;
        const currentBet = 1.00;
        let freeSpins = 0;
        let spinning = false;
        let autoSpinInterval = null;
        let litSymbols = new Set();
        let tourModeActive = false;
        let tourSpinsRemaining = 0;

        const BONUS_MESSAGE_TIMEOUT = 3000;
        
        // Rilevamento modalit√† "mobile-lite"
        const isMobileLite = (function() {
            const ua = (navigator.userAgent || navigator.vendor || window.opera || '').toLowerCase();
            const isMobileUA = /android|iphone|ipad|ipod|mobile|tablet/.test(ua);
            const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
            const touchCapable = ('ontouchstart' in window) || (navigator.maxTouchPoints || 0) > 0 || (navigator.msMaxTouchPoints || 0) > 0;
            const smallViewport = Math.min(window.innerWidth || 0, (screen && screen.width) || 0) <= 760;
            return isMobileUA || touchCapable || (coarse && smallViewport) || smallViewport;
        })();
        if (isMobileLite) {
            document.body.classList.add('mobile-lite');
        }
        
        // Funzione per generare un numero casuale tra min e max
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        const symbols = ['cherry', 'lemon', 'orange', 'grape', 'star', 'bell', 'diamond', 'clover', 'target'];
        
        const symbolToEmoji = {
            'cherry': 'üçí',
            'lemon': 'üçã',
            'orange': 'üçä',
            'grape': 'üçá',
            'star': '‚≠ê',
            'bell': 'üîî',
            'diamond': 'üíé',
            'clover': 'üçÄ',
            'target': 'üéØ'
        };

        const payouts = {
            'diamond': { 
                3: { multiplier: 20, freeSpins: 2 },
                4: { multiplier: 50, freeSpins: 5 },
                5: { multiplier: 100, freeSpins: 10 }
            },
            'star': { 
                3: { multiplier: 10, freeSpins: 1 },
                4: { multiplier: 25, freeSpins: 3 },
                5: { multiplier: 50, freeSpins: 5 }
            },
            'bell': { 
                3: { multiplier: 8, freeSpins: 0 },
                4: { multiplier: 15, freeSpins: 0 },
                5: { multiplier: 30, freeSpins: 0 }
            },
            'clover': { 
                3: { multiplier: 5, freeSpins: 0 },
                4: { multiplier: 10, freeSpins: 0 },
                5: { multiplier: 20, freeSpins: 0 }
            },
            'cherry': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            },
            'lemon': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            },
            'orange': { 
                3: { multiplier: 3, freeSpins: 10 },
                4: { multiplier: 6, freeSpins: 10 },
                5: { multiplier: 10, freeSpins: 10 }
            },
            'grape': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            },
            'target': { 
                3: { multiplier: 3, freeSpins: 0 },
                4: { multiplier: 6, freeSpins: 0 },
                5: { multiplier: 10, freeSpins: 0 }
            }
        };

        const balanceEl = document.getElementById('balance');
        const currentBetEl = document.getElementById('current-bet');
        const freeSpinsEl = document.getElementById('free-spins');
        const messageEl = document.getElementById('message');
        const spinButton = document.getElementById('spin-button');
        const autoButton = document.getElementById('auto-button');
        const slots = document.querySelectorAll('.slot');

        function addTouchEvents() {
            // Sound Toggle
            const soundBtn = document.getElementById('sound-toggle');
            soundBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const isMuted = soundManager.toggleMute();
                soundBtn.textContent = isMuted ? 'üîá' : 'üîä';
                soundBtn.style.background = isMuted ? 'rgba(255, 255, 255, 0.2)' : 'rgba(76, 175, 80, 0.6)';
            });
            
            spinButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(0)';
                    this.style.background = 'linear-gradient(135deg, #3d8b40, #45a049)';
                }
            });
            
            spinButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(-3px)';
                    this.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    spin();
                }
            });
            
            spinButton.addEventListener('click', function(e) {
                e.preventDefault();
                spin();
            });
            
            autoButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(0)';
                    this.style.background = 'linear-gradient(135deg, #00458a, #0056b3)';
                }
            });
            
            autoButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!this.disabled) {
                    this.style.transform = 'translateY(-3px)';
                    this.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
                    toggleAutoSpin();
                }
            });
            
            autoButton.addEventListener('click', function(e) {
                e.preventDefault();
                toggleAutoSpin();
            });
        }

        function updateBetDisplay() {
            currentBetEl.textContent = currentBet.toFixed(2);
        }

        function updateBalance() {
            balanceEl.textContent = balance.toFixed(2);
        }

        function updateFreeSpins() {
            freeSpinsEl.textContent = freeSpins;
        }

        function updateMessage(text, type = '') {
            if (tourModeActive) {
                const isTourStatus = text.includes('GIRO DEI BAR') || text.includes('giri rimanenti');
                const isCritical = text.includes('Saldo insufficiente') || text.includes('Game Over');
                if (!isTourStatus && !isCritical) {
                    return;
                }
            }
            messageEl.textContent = text;
            messageEl.className = 'message ' + type;
        }

        function getRandomSymbol() {
            return symbols[Math.floor(Math.random() * symbols.length)];
        }

    // Gestore sciame biciclette (istanza riutilizzabile)
        let bikeSwarm = null;

        // Funzione per attivare la TOUR MODE (ora usa BikeSwarm)
        function activateTourMode(spins) {
            tourModeActive = true;
            tourSpinsRemaining = spins;
            document.body.classList.add('tour-mode');
            document.querySelector('.slot-grid').classList.add('tour-mode');
            
            // Disattiva tutti i simboli (bar) all'inizio della TOUR MODE
            litSymbols.clear();
            const symbolsInRow = ['clover', 'bell', 'cherry', 'star', 'target'];
            symbolsInRow.forEach(symbol => {
                const symbolImg = document.querySelector(`.${symbol}-image`);
                if (symbolImg) symbolImg.classList.remove('symbol-highlight');
            });
            
            updateMessage(`üö≤ GIRO DEI BAR: ${tourSpinsRemaining} giri rimanenti üö¥`, 'bonus-message');
            
            // Avvia sciame biciclette (anche su mobile, ma ottimizzato)
            if (!bikeSwarm) {
                const isMobile = isMobileLite;
                const baseOptions = {
                    initialCount: isMobile ? 6 : 14,
                    maxBikes: isMobile ? 12 : 34,
                    spawnMin: isMobile ? 500 : 280,
                    spawnMax: isMobile ? 2000 : 1300,
                    baseSpeed: isMobile ? 10 : 8, // Pi√π veloci su mobile come richiesto
                    jitterChance: 0.035,
                    jitterMaxAngle: 0.35,
                    trailEnabled: !isMobile, // Disabilita scie su mobile per performance
                    targetFPS: 60
                };
                // Usa document.body come container per coprire tutto lo schermo
                bikeSwarm = new BikeSwarm(document.body, baseOptions);
            }
            bikeSwarm.start();
        }
        
        function toggleAutoSpin() {
            if (autoSpinInterval) {
                clearInterval(autoSpinInterval);
                autoSpinInterval = null;
                autoButton.textContent = 'AUTO üîÑ';
                spinButton.disabled = false;
                updateMessage('Modalit√† automatica disattivata', '');
            } else {
                if (balance < currentBet && freeSpins === 0) {
                    updateMessage('Saldo insufficiente per la modalit√† automatica!', 'lose-message');
                    return;
                }
                
                autoButton.textContent = 'STOP AUTO ‚èπÔ∏è';
                spinButton.disabled = true;
                updateMessage('Modalit√† automatica attiva...', 'win-message');
                
                spin();
                autoSpinInterval = setInterval(() => {
                    if (balance < currentBet && freeSpins === 0) {
                        clearInterval(autoSpinInterval);
                        autoSpinInterval = null;
                        autoButton.textContent = 'AUTO üîÑ';
                        spinButton.disabled = true;
                        updateMessage('Game Over! Ricarica il saldo per continuare.', 'lose-message');
                        spinButton.textContent = 'SALDO ESAURITO';
                    } else if (!spinning) {
                        spin();
                    }
                }, 3000); 
            }
        }

        function checkConsecutiveSymbols(line, symbol) {
            let maxConsecutive = 0;
            let currentConsecutive = 0;
            let startIndex = -1;
            let bestStartIndex = -1;
            
            for (let i = 0; i < line.length; i++) {
                if (line[i] === symbol) {
                    if (currentConsecutive === 0) {
                        startIndex = i;
                    }
                    currentConsecutive++;
                } else {
                    if (currentConsecutive > maxConsecutive) {
                        maxConsecutive = currentConsecutive;
                        bestStartIndex = startIndex;
                    }
                    currentConsecutive = 0;
                }
            }
            
            if (currentConsecutive > maxConsecutive) {
                maxConsecutive = currentConsecutive;
                bestStartIndex = startIndex;
            }
            
            return { count: maxConsecutive, startIndex: bestStartIndex };
        }

        function checkWin() {
            const grid = [];
            slots.forEach((slot, index) => {
                const row = Math.floor(index / 5);
                const col = index % 5;
                if (!grid[row]) grid[row] = [];
                grid[row][col] = slot.dataset.symbol; 
            });

            let winningLines = [];
            let totalWin = 0;
            let bonusFreeSpins = 0;

            for (let row = 0; row < 5; row++) {
                const rowSymbols = grid[row];
                const uniqueSymbols = [...new Set(rowSymbols)];
                
                for (const symbol of uniqueSymbols) {
                    const result = checkConsecutiveSymbols(rowSymbols, symbol);
                    if (result.count >= 3 && payouts[symbol]) {
                        const payout = payouts[symbol][result.count];
                        if (payout) {
                            const positions = [];
                            for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                                positions.push(row * 5 + i);
                            }
                            winningLines.push({
                                type: 'row',
                                index: row,
                                symbol: symbol,
                                count: result.count,
                                positions: positions
                            });
                            totalWin += currentBet * payout.multiplier;
                            bonusFreeSpins += payout.freeSpins;
                        }
                    }
                }
            }

            for (let col = 0; col < 5; col++) {
                const colSymbols = [];
                for (let row = 0; row < 5; row++) {
                    colSymbols.push(grid[row][col]);
                }
                const uniqueSymbols = [...new Set(colSymbols)];
                
                for (const symbol of uniqueSymbols) {
                    const result = checkConsecutiveSymbols(colSymbols, symbol);
                    if (result.count >= 3 && payouts[symbol]) {
                        const payout = payouts[symbol][result.count];
                        if (payout) {
                            const positions = [];
                            for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                                positions.push(i * 5 + col);
                            }
                            winningLines.push({
                                type: 'col',
                                index: col,
                                symbol: symbol,
                                count: result.count,
                                positions: positions
                            });
                            totalWin += currentBet * payout.multiplier;
                            bonusFreeSpins += payout.freeSpins;
                        }
                    }
                }
            }

            const diag1Symbols = [];
            for (let i = 0; i < 5; i++) {
                diag1Symbols.push(grid[i][i]);
            }
            const uniqueDiag1 = [...new Set(diag1Symbols)];
            
            for (const symbol of uniqueDiag1) {
                const result = checkConsecutiveSymbols(diag1Symbols, symbol);
                if (result.count >= 3 && payouts[symbol]) {
                    const payout = payouts[symbol][result.count];
                    if (payout) {
                        const positions = [];
                        for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                            positions.push(i * 6);
                        }
                        winningLines.push({
                            type: 'diag1',
                            symbol: symbol,
                            count: result.count,
                            positions: positions
                        });
                        totalWin += currentBet * payout.multiplier;
                        bonusFreeSpins += payout.freeSpins;
                    }
                }
            }

            const diag2Symbols = [];
            for (let i = 0; i < 5; i++) {
                diag2Symbols.push(grid[i][4-i]);
            }
            const uniqueDiag2 = [...new Set(diag2Symbols)];
            
            for (const symbol of uniqueDiag2) {
                const result = checkConsecutiveSymbols(diag2Symbols, symbol);
                if (result.count >= 3 && payouts[symbol]) {
                    const payout = payouts[symbol][result.count];
                    if (payout) {
                        const positions = [];
                        for (let i = result.startIndex; i < result.startIndex + result.count; i++) {
                            positions.push(i * 4 + 4); 
                        }
                        winningLines.push({
                            type: 'diag2',
                            symbol: symbol,
                            count: result.count,
                            positions: positions
                        });
                        totalWin += currentBet * payout.multiplier;
                        bonusFreeSpins += payout.freeSpins;
                    }
                }
            }

            // Check for PADRI FONDATORI combination (orange, grape, lemon in any order)
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col <= 2; col++) {
                    const threeSymbols = [
                        grid[row][col],
                        grid[row][col + 1],
                        grid[row][col + 2]
                    ];
                    
                    const foundatorsSymbols = new Set(['orange', 'grape', 'lemon']);
                    const currentSymbols = new Set(threeSymbols);
                    
                    if (threeSymbols.every(symbol => foundatorsSymbols.has(symbol)) &&
                        currentSymbols.size === 3) { // All three must be different
                        const positions = [
                            row * 5 + col,
                            row * 5 + (col + 1),
                            row * 5 + (col + 2)
                        ];
                        winningLines.push({
                            type: 'foundators',
                            positions: positions,
                            symbol: 'foundators'
                        });
                        // Add special bonus for PADRI FONDATORI (77x multiplier)
                        totalWin += currentBet * 77;
                        bonusFreeSpins += 7; // 7 free spins for luck
                    }
                }
            }

            return { winningLines, totalWin, bonusFreeSpins };
        }

        function highlightWinningLines(winningLines) {
            // Reset slot highlights
            slots.forEach(slot => {
                slot.classList.remove('winning');
            });

            // Set of winning symbols for this spin
            const winningSymbols = new Set();

            winningLines.forEach(line => {
                line.positions.forEach(pos => {
                    slots[pos].classList.add('winning');
                });
                winningSymbols.add(line.symbol);
            });

            // Add new winning symbols to the permanent lit set only if not in TOUR MODE
            if (!tourModeActive) {
                winningSymbols.forEach(symbol => {
                    litSymbols.add(symbol);
                    const symbolImg = document.querySelector(`.${symbol}-image`);
                    if (symbolImg) {
                        symbolImg.classList.add('symbol-highlight');
                    }
                });
            }

            // Check if all symbols in the row are lit
            const symbolsInRow = ['clover', 'bell', 'cherry', 'star', 'target'];
            const allSymbolsLit = symbolsInRow.every(symbol => litSymbols.has(symbol));

            // If all symbols are lit, show the BONUS message
            if (allSymbolsLit) {
                const finalTourSpins = getRandomInt(10, 50);
                const bonusAmount = currentBet * 50; // Bonus fisso di 50x
                balance += bonusAmount;
                updateBalance();

                // Show popup and start number animation
                const popup = document.getElementById('completionPopup');
                const numberScroll = document.getElementById('numberScroll');
                popup.style.display = 'flex';
                updateMessage(`üåü GIRO DEI BAR! +${bonusAmount.toFixed(2)}‚Ç¨ üåü`, 'bonus-message');

                // Funzione per creare l'effetto di scrolling dei numeri
                function animateNumbers() {
                    let duration = 2000;
                    let steps = 30;
                    let interval = duration / steps;
                    let count = 0;

                    numberScroll.innerHTML = '';
                    
                    const animation = setInterval(() => {
                        count++;
                        let randomNum = getRandomInt(10, 50);
                        
                        // Rimuovi il numero precedente
                        const oldNumber = numberScroll.querySelector('.visible');
                        if (oldNumber) {
                            oldNumber.classList.remove('visible');
                            setTimeout(() => oldNumber.remove(), 100);
                        }

                        // Aggiungi il nuovo numero
                        const numberDiv = document.createElement('div');
                        numberDiv.className = 'number';
                        numberDiv.textContent = count >= steps ? finalTourSpins : randomNum;
                        numberScroll.appendChild(numberDiv);
                        
                        // Forza un reflow
                        numberDiv.offsetHeight;
                        
                        // Rendi visibile il numero
                        numberDiv.classList.add('visible');

                        if (count >= steps) {
                            clearInterval(animation);
                        }
                    }, interval);
                }

                // Avvia l'animazione dei numeri
                animateNumbers();

                // Stop auto-spin if active
                if (autoSpinInterval) {
                    clearInterval(autoSpinInterval);
                    autoSpinInterval = null;
                    autoButton.textContent = 'AUTO üîÑ';
                    spinButton.disabled = false;
                }

                // Handle popup close button
                document.getElementById('closePopup').onclick = function() {
                    popup.style.display = 'none';
                    activateTourMode(finalTourSpins);
                };
            }
        }

        async function spin() {
            if (spinning) return;
            
            if (tourModeActive) {
                tourSpinsRemaining--;
                updateMessage(`üö≤ GIRO DEI BAR: ${tourSpinsRemaining} giri rimanenti üö¥`, 'bonus-message');
                if (tourSpinsRemaining === 0) {
                    tourModeActive = false;
                    document.body.classList.remove('tour-mode');
                    document.querySelector('.slot-grid').classList.remove('tour-mode');
                    // Ferma e pulisci lo sciame biciclette
                    if (bikeSwarm) {
                        bikeSwarm.stop();
                    }
                    // Rimuovi eventuali scie residue
                    document.querySelectorAll('.bike-trail').forEach(n => n.remove());
                    // Reset dei simboli solo alla fine della TOUR MODE
                    litSymbols.clear();
                    document.querySelectorAll('.clover-image, .bell-image, .cherry-image, .star-image, .target-image')
                        .forEach(img => img.classList.remove('symbol-highlight'));
                    updateMessage('GIRO DEI BAR completato! üèÅ', 'win-message');
                }
            }
            
            if (balance < currentBet && freeSpins === 0) {
                updateMessage('Saldo insufficiente!', 'lose-message');
                if (autoSpinInterval) {
                    clearInterval(autoSpinInterval);
                    autoSpinInterval = null;
                    autoButton.textContent = 'AUTO üîÑ';
                    spinButton.disabled = true;
                    spinButton.textContent = 'SALDO ESAURITO';
                }
                return;
            }

            spinning = true;
            spinButton.disabled = true;
            soundManager.playSpin();
            
            if (!autoSpinInterval) {
                 spinButton.textContent = 'GIRANDO...';
            }

            slots.forEach(slot => {
                slot.classList.remove('winning');
                slot.classList.remove('stopping');
            });

            let isFreeSpinUsed = false;
            if (freeSpins > 0) {
                freeSpins--;
                isFreeSpinUsed = true;
                updateFreeSpins();
                updateMessage('FREE SPIN! üéÅ', 'win-message');
            } else {
                balance -= currentBet;
                updateBalance();
            }

            slots.forEach(slot => {
                slot.classList.add('spinning');
            });

            // Cascade stop logic
            const cols = 5;
            const rows = 5;
            
            for (let col = 0; col < cols; col++) {
                await new Promise(resolve => setTimeout(resolve, 150)); // Delay between columns

                for (let row = 0; row < rows; row++) {
                    const index = row * 5 + col;
                    const slot = slots[index];
                    
                    const randomSymbolName = getRandomSymbol();
                    slot.dataset.symbol = randomSymbolName; 
                    slot.innerHTML = `<img src="images/${randomSymbolName}.png" alt="${randomSymbolName}">`;
                    
                    slot.classList.remove('spinning');
                    slot.classList.add('stopping');
                }
            }

            await new Promise(resolve => setTimeout(resolve, 300));

            const result = checkWin();
            
            if (result.winningLines.length > 0) {
                soundManager.playWin();
                highlightWinningLines(result.winningLines);
                
                balance += result.totalWin;
                freeSpins += result.bonusFreeSpins;
                
                // Check for PADRI FONDATORI special win
                const foundatorsWin = result.winningLines.find(line => line.type === 'foundators');
                if (foundatorsWin) {
                    const message = `üèÜ PADRI FONDATORI! +${(currentBet * 77).toFixed(2)}‚Ç¨ + 7 Free Spins! üé∞`;
                    updateMessage(message, 'foundators-message');
                    // Boost forte allo sciame durante la TOUR MODE
                    if (tourModeActive && bikeSwarm && typeof bikeSwarm.boost === 'function') {
                        bikeSwarm.boost({ extraBikes: 12, duration: 4000, spawnMin: 80, spawnMax: 200, maxBikesInc: 15 });
                    }
                } else {
                    let message = `üéâ VINCITA! +${result.totalWin.toFixed(2)}‚Ç¨`;
                    if (result.bonusFreeSpins > 0) {
                        message += ` + ${result.bonusFreeSpins} Free Spins! üéÅ`;
                    }
                    
                    const bestWin = result.winningLines.reduce((best, line) => 
                        line.count > best.count ? line : best
                    );
                    message += ` (${bestWin.count} ${symbolToEmoji[bestWin.symbol]})`;
                    
                    updateMessage(message, 'win-message');
                    // Boost moderato in base alla forza della linea migliore
                    if (tourModeActive && bikeSwarm && typeof bikeSwarm.boost === 'function') {
                        if (bestWin.count >= 5) {
                            bikeSwarm.boost({ extraBikes: 8, duration: 3000, spawnMin: 120, spawnMax: 260, maxBikesInc: 10 });
                        } else if (bestWin.count === 4) {
                            bikeSwarm.boost({ extraBikes: 5, duration: 2200, spawnMin: 180, spawnMax: 320, maxBikesInc: 6 });
                        }
                    }
                }
                
                updateBalance();
                updateFreeSpins();
            } else {
                soundManager.playLose();
                if (!isFreeSpinUsed) {
                    updateMessage('Riprova! üé≤', 'lose-message');
                } else {
                    updateMessage('Free Spin utilizzato! üéÅ', 'lose-message');
                }
            }
            
            setTimeout(() => {
                if (balance < currentBet && freeSpins === 0) {
                    updateMessage('Game Over! Ricarica il saldo per continuare.', 'lose-message');
                    spinButton.textContent = 'SALDO ESAURITO';
                    spinButton.disabled = true;
                    autoButton.disabled = true;
                } else {
                    if (!autoSpinInterval) {
                        spinButton.disabled = false;
                        spinButton.textContent = freeSpins > 0 ? 'GIRA GRATIS! üéÅ' : 'GIRA! üé∞';
                    }
                    autoButton.disabled = false;
                }
                spinning = false;
            }, 500);
        }

        function initializeSlots() {
            slots.forEach(slot => {
                const randomSymbolName = getRandomSymbol();
                slot.dataset.symbol = randomSymbolName;
                slot.innerHTML = `<img src="images/${randomSymbolName}.png" alt="${randomSymbolName}">`;
            });
        }

        function toggleSymbol(symbol) {
            // Non permettere il toggle dei simboli durante la TOUR MODE
            if (tourModeActive) return;

            const symbolImg = document.querySelector(`.${symbol}-image`);
            if (symbolImg) {
                if (symbolImg.classList.contains('symbol-highlight')) {
                    symbolImg.classList.remove('symbol-highlight');
                    litSymbols.delete(symbol);
                } else {
                    symbolImg.classList.add('symbol-highlight');
                    litSymbols.add(symbol);
                }

                // Controlla se tutti i simboli sono attivati
                const symbolsInRow = ['clover', 'bell', 'cherry', 'star', 'target'];
                const allSymbolsLit = symbolsInRow.every(s => litSymbols.has(s));

                if (allSymbolsLit) {
                    const finalTourSpins = getRandomInt(10, 50);
                    const bonusAmount = currentBet * 50;
                    balance += bonusAmount;
                    updateBalance();

                    const popup = document.getElementById('completionPopup');
                    const numberScroll = document.getElementById('numberScroll');
                    popup.style.display = 'flex';
                    updateMessage(`üåü GIRO DEI BAR! +${bonusAmount.toFixed(2)}‚Ç¨ üåü`, 'bonus-message');

                    function animateNumbers() {
                        let duration = 2000;
                        let steps = 30;
                        let interval = duration / steps;
                        let count = 0;

                        numberScroll.innerHTML = '';
                        
                        const animation = setInterval(() => {
                            count++;
                            let randomNum = getRandomInt(10, 50);
                            
                            const oldNumber = numberScroll.querySelector('.visible');
                            if (oldNumber) {
                                oldNumber.classList.remove('visible');
                                setTimeout(() => oldNumber.remove(), 100);
                            }

                            const numberDiv = document.createElement('div');
                            numberDiv.className = 'number';
                            numberDiv.textContent = count >= steps ? finalTourSpins : randomNum;
                            numberScroll.appendChild(numberDiv);
                            
                            numberDiv.offsetHeight;
                            
                            numberDiv.classList.add('visible');

                            if (count >= steps) {
                                clearInterval(animation);
                            }
                        }, interval);
                    }

                    animateNumbers();

                    if (autoSpinInterval) {
                        clearInterval(autoSpinInterval);
                        autoSpinInterval = null;
                        autoButton.textContent = 'AUTO üîÑ';
                        spinButton.disabled = false;
                    }

                    document.getElementById('closePopup').onclick = function() {
                        popup.style.display = 'none';
                        activateTourMode(finalTourSpins);
                    };

                    setTimeout(() => {
                        litSymbols.clear();
                        document.querySelectorAll('.clover-image, .bell-image, .cherry-image, .star-image, .target-image')
                            .forEach(img => img.classList.remove('symbol-highlight'));
                        updateMessage('Simboli resettati! Raccoglili di nuovo!', '');
                    }, BONUS_MESSAGE_TIMEOUT);
                }
            }
        }

    // Interazione manuale sui simboli rimossa: il set di simboli si accende solo quando
    // viene vinto il simbolo corrispondente. Se necessario riabilitare per debug,
    // reinserire le addEventListener qui sotto (commentate di proposito).
    // document.querySelector('.clover-image').addEventListener('click', () => toggleSymbol('clover'));
    // document.querySelector('.bell-image').addEventListener('click', () => toggleSymbol('bell'));
    // document.querySelector('.cherry-image').addEventListener('click', () => toggleSymbol('cherry'));
    // document.querySelector('.star-image').addEventListener('click', () => toggleSymbol('star'));
    // document.querySelector('.target-image').addEventListener('click', () => toggleSymbol('target'));
        
        updateBalance();
        updateBetDisplay();
        updateFreeSpins();
        initializeSlots();
        addTouchEvents();

        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Rimozione pannello debug: semplifica interazione mobile.
    </script>
</body>
</html>